@page
@model KTU_forum.Pages.MessHallModel
@{
    var username = Model.Username;
    var profilePic = Model.ProfilePicturePath;
}

<div class="container">
    <div class="card shadow border-0 rounded-4 mb-5">
        <div class="card-body p-4">
            <!-- Chat Messages Area -->
            <div class="messages-container">
                <ul id="messagesList" class="list-unstyled">
                    <!-- Messages will appear here -->
                </ul>
            </div>

            <!-- Message Input Area -->
            <div class="message-input-area">
                <div class="d-flex">
                    <input type="text" id="messageInput" class="form-control me-2" placeholder="Enter your message" />
                    <button id="sendButton" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SignalR JS Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.10/signalr.min.js"></script>
<script>
    var username = '@username';
    var profilePicPath = '@profilePic';
    const currentDate = new Date();

    const year = currentDate.getFullYear();
    const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
    const day = currentDate.getDate().toString().padStart(2, '0');
    const hours = currentDate.getHours().toString().padStart(2, '0');
    const minutes = currentDate.getMinutes().toString().padStart(2, '0');

    const formattedDate = `${year}-${month}-${day} | ${hours}:${minutes}`;

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .build();

    connection.start().catch(err => console.error(err));

    // ⚠️ Modified this to accept profilePicPath from the server
    connection.on("ReceiveMessage", function (user, message, profilePic) {
        const messagesList = document.getElementById("messagesList");

        const messageItem = document.createElement("li");
        messageItem.classList.add("d-flex", "align-items-start", "mb-3");

        const img = document.createElement("img");
        img.src = profilePic || '/pfps/default.png'; // fallback
        img.alt = user + "'s profile picture";
        img.classList.add("rounded-circle");
        img.style.width = "40px";
        img.style.height = "40px";
        img.style.objectFit = "cover";
        img.style.marginRight = "10px";

        const messageContent = document.createElement("div");

        const meta = document.createElement("small");
        meta.classList.add("text-muted");
        meta.textContent = `${user} • ${formattedDate}`;

        const messageText = document.createElement("p");
        messageText.classList.add("mb-1");
        messageText.textContent = message;

        messageContent.appendChild(meta);
        messageContent.appendChild(messageText);

        messageItem.appendChild(img);
        messageItem.appendChild(messageContent);

        messagesList.appendChild(messageItem);
        messagesList.scrollTop = messagesList.scrollHeight;
    });

    document.getElementById("sendButton").addEventListener("click", function () {
        const message = document.getElementById("messageInput").value;

        if (!username) {
            alert("Please log in.");
            return;
        }

        if (!message.trim()) {
            alert("Please input a message.");
            return;
        }

        connection.invoke("SendMessage", username, message)
            .catch(err => console.error(err.toString()));

        document.getElementById("messageInput").value = "";
    });
</script>
