@page
@model KTU_forum.Pages.MessHallModel
@{
    var roomName = Model.RoomName;
    var username = Model.Username;
    var profilePic = Model.ProfilePicturePath;
    var userRole = Model.UserRole; // Added user role
}
<div class="container-fluid vh-100 d-flex flex-column">
    <div class="card shadow border-0 rounded-4 mb-0 flex-fill">
        <div class="card-body p-4 d-flex flex-column">
            <!-- Chat Messages Area -->
            <div class="messages-container flex-fill overflow-auto" style="max-height: calc(100vh - 150px);">
                <ul id="messagesList" class="list-unstyled">
                    @foreach (var message in Model.Messages)
                    {
                        var formattedTime = message.SentAt.ToString("yyyy-MM-dd | HH:mm");
                        <li class="d-flex align-items-start mb-3 message-item position-relative">
                            <img src="@message.SenderProfilePic" alt="@message.SenderUsername's profile picture" class="rounded-circle profile-pic"
                                 style="width: 40px; height: 40px; object-fit: cover; margin-right: 10px;">
                            <div>
                                <small class="text-muted">
                                    @message.SenderUsername
                                    @if (!string.IsNullOrEmpty(message.SenderRole))
                                    {
                                        <span class="badge bg-success text-white ms-1" style="opacity: 0.4; font-size: 0.75rem;">@message.SenderRole</span>
                                    }
                                    • @formattedTime
                                </small>
                                <p class="mb-1">@message.Content</p>
                            </div>

                            <div class="message-actions position-absolute top-0 end-0 me-2 mt-2">
                                <button class="btn btn-sm btn-light message-options-btn">...</button>
                                <div class="message-menu d-none bg-light border rounded shadow-sm p-2">
                                    <button class="btn btn-sm btn-outline-primary me-1 like-btn" data-message-id="@message.MessageId">👍 Like</button>
                                    <button class="btn btn-sm btn-outline-primary reply-btn">↩️ Reply</button>
                                    <a href="/PublicProfile/@message.SenderUsername" class="btn btn-sm btn-outline-primary view-profile-btn">
                                        👤 View Profile
                                    </a>
                                </div>
                            </div>
                        </li>
                    }
                </ul>
            </div>
            <!-- Message Input Area -->
            <div class="message-input-area mt-3">
                <div class="d-flex">
                    <input type="text" id="messageInput" class="form-control me-2" placeholder="Enter your message" />
                    <button id="sendButton" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SignalR JS Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.10/signalr.min.js"></script>
<script>
    var username = '@username';
    var profilePicPath = '@profilePic';
    var roomName = '@roomName';
    var userRole = '@userRole'; // Added user role JavaScript variable

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .build();

    connection.start()
        .then(function () {
            connection.invoke("JoinRoom", roomName);
        })
        .catch(function (err) {
            return console.error(err.toString());
        });

    connection.on("ReceiveMessage", function (user, message, profilePic, role) {
        const messagesList = document.getElementById("messagesList");
        const messageItem = document.createElement("li");
        messageItem.classList.add("d-flex", "align-items-start", "mb-3", "message-item", "position-relative");

        const img = document.createElement("img");
        img.src = profilePic || '/pfps/default.png'; // fallback
        img.alt = user + "'s profile picture";
        img.classList.add("rounded-circle", "profile-pic");
        img.style.width = "40px";
        img.style.height = "40px";
        img.style.objectFit = "cover";
        img.style.marginRight = "10px";

        const messageContent = document.createElement("div");
        const meta = document.createElement("small");
        meta.classList.add("text-muted");

        const currentDate = new Date();
        const year = currentDate.getFullYear();
        const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
        const day = currentDate.getDate().toString().padStart(2, '0');
        const hours = currentDate.getHours().toString().padStart(2, '0');
        const minutes = currentDate.getMinutes().toString().padStart(2, '0');
        const formattedDate = `${year}-${month}-${day} | ${hours}:${minutes}`;

        // Create the username and role part
        meta.innerHTML = `${user}`;

        // Add role badge if role exists
        if (role) {
            const roleBadge = document.createElement("span");
            roleBadge.classList.add("badge", "bg-success", "text-white", "ms-1");
            roleBadge.style.opacity = "0.4";
            roleBadge.style.fontSize = "0.75rem";
            roleBadge.textContent = role;
            meta.appendChild(roleBadge);
        }

        // Add the timestamp
        meta.innerHTML += ` • ${formattedDate}`;

        const messageText = document.createElement("p");
        messageText.classList.add("mb-1");
        messageText.textContent = message;

        const messageActions = document.createElement("div");
        messageActions.classList.add("message-actions", "position-absolute", "top-0", "end-0", "me-2", "mt-2");

        const optionsButton = document.createElement("button");
        optionsButton.classList.add("btn", "btn-sm", "btn-light", "message-options-btn");
        optionsButton.textContent = "...";

        const messageMenu = document.createElement("div");
        messageMenu.classList.add("message-menu", "d-none", "bg-light", "border", "rounded", "shadow-sm", "p-2");

        const likeButton = document.createElement("button");
        likeButton.classList.add("btn", "btn-sm", "btn-outline-primary", "me-1", "like-btn");
        likeButton.textContent = "👍 Like";
        likeButton.dataset.messageId = "TEMP_ID"; // You'll need to handle setting the actual message ID on creation

        const replyButton = document.createElement("button");
        replyButton.classList.add("btn", "btn-sm", "btn-outline-secondary", "reply-btn");
        replyButton.textContent = "↩️ Reply";

        const viewProfileLink = document.createElement("a");
        viewProfileLink.href = `/PublicProfile/${user}`;
        viewProfileLink.classList.add("btn", "btn-sm", "btn-outline-info", "view-profile-btn");
        viewProfileLink.textContent = "👤 View Profile";

        messageMenu.appendChild(likeButton);
        messageMenu.appendChild(replyButton);
        messageMenu.appendChild(viewProfileLink);
        messageActions.appendChild(optionsButton);
        messageActions.appendChild(messageMenu);

        messageContent.appendChild(meta);
        messageContent.appendChild(messageText);
        messageItem.appendChild(img);
        messageItem.appendChild(messageContent);
        messageItem.appendChild(messageActions);
        messagesList.appendChild(messageItem);

        messagesList.scrollTop = messagesList.scrollHeight;

        // Add the click event to the like button (moved inside the message creation)
        likeButton.addEventListener("click", function () {
            const messageId = this.dataset.messageId; // Get the message ID from the button
            connection.invoke("LikeMessage", messageId, username)
                .catch(err => console.error(err.toString()));
        });
    });

    document.addEventListener("click", function (event) {
        if (event.target.classList.contains("message-options-btn")) {
            const messageActions = event.target.closest(".message-actions");
            const menu = messageActions.querySelector(".message-menu");
            menu.classList.toggle("d-none");
        } else if (!event.target.closest(".message-actions")) {
            // Close any open menus if clicking outside the actions area
            document.querySelectorAll(".message-menu:not(.d-none)").forEach(menu => {
                menu.classList.add("d-none");
            });
        }
    });

    document.getElementById("sendButton").addEventListener("click", function () {
        sendMessage();
    });

    document.getElementById("messageInput").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });

    function sendMessage() {
        const message = document.getElementById("messageInput").value;
        if (!username) {
            alert("Please log in.");
            return;
        }
        if (!message.trim()) {
            alert("Please input a message.");
            return;
        }

        connection.invoke("SendMessage", username, roomName, message, userRole) // Added userRole parameter
            .catch(err => console.error(err.toString()));

        document.getElementById("messageInput").value = "";
    }

    // Scroll to bottom when page loads
    window.onload = function () {
        const messagesList = document.getElementById("messagesList");
        messagesList.scrollTop = messagesList.scrollHeight;
    }
</script>

<style>
    /* Your CSS rules here */
    .message-actions {
        position: absolute;
        top: 0;
        right: 0;
        margin-top: 0.5rem;
        margin-right: 0.5rem;
        display: flex;
        align-items: center;
    }

    .message-options-btn {
        padding: 0.1rem 0.5rem;
        line-height: 1;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f8f9fa;
        cursor: pointer;
    }

        .message-options-btn:hover {
            background-color: #e9ecef;
        }

    .message-menu {
        position: absolute;
        top: 100%; /* Position below the button */
        right: 0;
        z-index: 10;
        min-width: 100px; /* Adjust as needed */
    }

        .message-menu button,
        .message-menu a {
            display: block;
            width: 100%;
            padding: 0.25rem 0.5rem;
            text-align: left;
            white-space: nowrap;
        }

            .message-menu button:hover,
            .message-menu a:hover {
                background-color: #e9ecef;
            }
</style>