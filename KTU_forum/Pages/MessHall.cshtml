@page
@model KTU_forum.Pages.MessHallModel
@{ var username = HttpContext.Session.GetString("Username"); // Retrieve the session username
}

<div class="container">
    <div class="card shadow border-0 rounded-4 mb-5">
        <div class="card-body p-4">
            <!-- Chat Messages Area -->
            <div class="messages-container">
                <ul id="messagesList" class="list-unstyled">
                    <!-- Messages will appear here -->
                </ul>
            </div>

            <!-- Message Input Area -->
            <div class="message-input-area">
                <div class="d-flex">
                    <input type="text" id="messageInput" class="form-control me-2" placeholder="Enter your message" />
                    <button id="sendButton" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SignalR JS Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.10/signalr.min.js"></script>
<script>
    // Get the username from the Razor Page
    var username = '@username';

    const currentDate = new Date();

    // Get the year, month, day, hours, and minutes
    const year = currentDate.getFullYear();
    const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');  // Months are 0-indexed
    const day = currentDate.getDate().toString().padStart(2, '0');
    const hours = currentDate.getHours().toString().padStart(2, '0');
    const minutes = currentDate.getMinutes().toString().padStart(2, '0');

    // Format the date and time in "YYYY-MM-DD HH:mm"
    const formattedDate = `${year}-${month}-${day} | ${hours}:${minutes}`;

    // Create a connection to the SignalR Hub
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub") // This is the URL of your SignalR hub
        .build();

    // Function to start the SignalR connection
    connection.start().catch(err => console.error(err));

    // Listen for incoming messages from the SignalR Hub
    connection.on("ReceiveMessage", function (user, message) {
        const li = document.createElement("li");
        li.textContent = `${formattedDate} ${user}: ${message}`;

        // Append the message to the messagesList
        const messagesList = document.getElementById("messagesList");
        messagesList.appendChild(li);

        // Optionally, scroll to the bottom of the messages list
        messagesList.scrollTop = messagesList.scrollHeight;
    });

    // Send message to the SignalR Hub when the button is clicked
    document.getElementById("sendButton").addEventListener("click", function () {
        const message = document.getElementById("messageInput").value;

        if (username && message) {
            // Send the message to the SignalR Hub
            connection.invoke("SendMessage", username, message)
                .catch(err => console.error(err.toString()));

            // Clear the message input field after sending
            document.getElementById("messageInput").value = "";
        }
        if (username == "") {
            alert("PLease Login");
        }
        if (message == "") {
            alert("PLease imput a message");

        }
    });

</script>
